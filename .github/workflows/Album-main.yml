# .github/workflows/Album-main.yml
name: Generate Album Videos

on:
  workflow_dispatch:
    inputs:
      artist:
        description: 'Artist Name'
        required: true
        default: 'Taylor Swift'
      album:
        description: 'Album Name'
        required: true
        default: 'Midnights'
      max_tracks_per_run:
        description: 'Max tracks per run (default: 2)'
        required: false
        default: '2'
  repository_dispatch:
    types: [continue-album]

jobs:
  fetch-album:
    runs-on: ubuntu-latest
    # Only run fetch-album on workflow_dispatch, not on continue-album
    if: github.event_name == 'workflow_dispatch'
    outputs:
      album_file: ${{ steps.fetch.outputs.album_file }}
      artist: ${{ steps.fetch.outputs.artist }}
      album: ${{ steps.fetch.outputs.album }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Install dependencies
      run: |
        pip install yt-dlp musicbrainzngs
    
    - name: Fetch album data
      id: fetch
      run: |
        # Store inputs in variables to avoid trailing space issues
        ARTIST="${{ github.event.inputs.artist }}"
        ALBUM="${{ github.event.inputs.album }}"
        
        # Trim whitespace
        ARTIST=$(echo "$ARTIST" | xargs)
        ALBUM=$(echo "$ALBUM" | xargs)
        
        # Run fetch script
        python fetch_album.py "$ARTIST" "$ALBUM"
        
        # Get the actual filename that was created (not the input)
        ALBUM_FILE=$(ls -1 *.json | head -1)
        
        if [ -z "$ALBUM_FILE" ]; then
          echo "❌ No JSON file created"
          exit 1
        fi
        
        # Extract actual artist and album name from the filename
        ACTUAL_ARTIST=$(echo "$ALBUM_FILE" | sed 's/ - .*//')
        ACTUAL_ALBUM=$(echo "$ALBUM_FILE" | sed 's/.*- //;s/.json$//')
        
        echo "album_file=$ALBUM_FILE" >> $GITHUB_OUTPUT
        echo "artist=$ACTUAL_ARTIST" >> $GITHUB_OUTPUT
        echo "album=$ACTUAL_ALBUM" >> $GITHUB_OUTPUT
        echo "Generated album file: $ALBUM_FILE"
    
    - name: Upload album data
      uses: actions/upload-artifact@v4
      with:
        name: album-data
        path: "*.json"

  generate-tracks:
    needs: fetch-album
    runs-on: ubuntu-latest
    if: always()
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set workflow variables
      id: vars
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          # First run - use outputs from fetch-album job
          echo "artist=${{ needs.fetch-album.outputs.artist }}" >> $GITHUB_OUTPUT
          echo "album=${{ needs.fetch-album.outputs.album }}" >> $GITHUB_OUTPUT
          echo "max_tracks=${{ github.event.inputs.max_tracks_per_run }}" >> $GITHUB_OUTPUT
          echo "album_file=${{ needs.fetch-album.outputs.album_file }}" >> $GITHUB_OUTPUT
        else
          # Continuation - use client_payload
          ARTIST="${{ github.event.client_payload.artist }}"
          ALBUM="${{ github.event.client_payload.album }}"
          
          # Construct album filename from payload
          ALBUM_FILE="${ARTIST} - ${ALBUM}.json"
          
          echo "artist=$ARTIST" >> $GITHUB_OUTPUT
          echo "album=$ALBUM" >> $GITHUB_OUTPUT
          echo "max_tracks=${{ github.event.client_payload.max_tracks_per_run }}" >> $GITHUB_OUTPUT
          echo "album_file=$ALBUM_FILE" >> $GITHUB_OUTPUT
        fi
    
    - name: Download album data
      uses: actions/download-artifact@v4
      with:
        name: album-data
      continue-on-error: true
    
    - name: Download from previous run if not found
      if: github.event_name == 'repository_dispatch'
      run: |
        # Try to get album data from previous workflow run
        ALBUM_FILE="${{ steps.vars.outputs.album_file }}"
        
        if [ ! -f "$ALBUM_FILE" ]; then
          echo "Album file not in artifacts, trying to download from latest release..."
          gh release download album-data -p "*.json" || echo "No release found"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Verify downloaded files
      run: |
        echo "Files in current directory:"
        ls -la *.json || echo "No JSON files found"
        echo ""
        echo "Looking for: ${{ steps.vars.outputs.album_file }}"
    
    - name: Download progress (if exists)
      continue-on-error: true
      run: |
        gh release download progress-data -p album_progress.json || echo "No previous progress"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Cache GIF dataset
      id: cache-gifs
      uses: actions/cache@v4
      with:
        path: data/giphy.zip
        key: giphy-dataset-v1
    
    - name: Download GIF dataset
      if: steps.cache-gifs.outputs.cache-hit != 'true'
      run: |
        mkdir -p data
        pip install gdown
        gdown --id 1DxON0BqgvY8vX9s4twtmPWmmuVW51pE- -O data/giphy.zip
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg espeak-ng imagemagick
    
    - name: Install Python dependencies
      run: |
        pip install --upgrade pip
        pip install gradio_client groq moviepy soundfile pydub numpy requests
        pip install git+https://github.com/MrViincciLeRoy/LyricFlow.git#egg=LyricFlow[dev]
    
    - name: Run album pipeline
      id: pipeline
      env:
        GROQ_API_KEYS: ${{ secrets.GROQ_API_KEYS }}
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
      run: |
        ALBUM_FILE="${{ steps.vars.outputs.album_file }}"
        MAX_TRACKS="${{ steps.vars.outputs.max_tracks }}"
        
        echo "Looking for album file: $ALBUM_FILE"
        
        if [ ! -f "$ALBUM_FILE" ]; then
          echo "❌ Album file not found: $ALBUM_FILE"
          echo "Available files:"
          ls -la
          exit 1
        fi
        
        python album_pipeline.py "$ALBUM_FILE" "$MAX_TRACKS"
        echo "status=$?" >> $GITHUB_OUTPUT
    
    - name: Upload album data for next run
      if: always() && github.event_name == 'workflow_dispatch'
      run: |
        ALBUM_FILE="${{ steps.vars.outputs.album_file }}"
        gh release create album-data "$ALBUM_FILE" --title "Album Data" || \
        gh release upload album-data "$ALBUM_FILE" --clobber
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Upload progress tracking
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: album-progress
        path: album_progress.json
    
    - name: Upload completed videos
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: track-videos
        path: outputs/*.mp4
    
    - name: Save progress to release
      if: always()
      run: |
        if [ -f album_progress.json ]; then
          gh release create progress-data album_progress.json --title "Album Progress" || \
          gh release upload progress-data album_progress.json --clobber
        else
          echo "⚠️ album_progress.json not found, skipping release upload"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Check if more tracks needed
      id: check_continue
      run: |
        if [ -f album_progress.json ]; then
          STATUS=$(python -c "import json; p=json.load(open('album_progress.json')); print(p['status'])")
          echo "album_status=$STATUS" >> $GITHUB_OUTPUT
        else
          echo "album_status=failed" >> $GITHUB_OUTPUT
        fi
    
    - name: Wait 10 minutes before next batch
      if: steps.check_continue.outputs.album_status == 'paused'
      run: |
        echo "⏸️  Pausing for 10 minutes..."
        sleep 600
    
    - name: Trigger next batch
      if: steps.check_continue.outputs.album_status == 'paused'
      uses: peter-evans/repository-dispatch@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        event-type: continue-album
        client-payload: '{"artist": "${{ steps.vars.outputs.artist }}", "album": "${{ steps.vars.outputs.album }}", "max_tracks_per_run": "${{ steps.vars.outputs.max_tracks }}"}'

  merge-album:
    needs: generate-tracks
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: '*'
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg
        pip install moviepy
    
    - name: Merge videos
      run: |
        if [ -f album_progress.json ]; then
          python merge_videos.py
        else
          echo "⚠️ No progress file found, skipping merge"
        fi
    
    - name: Upload full album video
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: full-album-video
        path: outputs/*_full_album.mp4
