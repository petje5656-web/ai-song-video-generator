# .github/workflows/Album-main.yml
name: Generate Album Videos

on:
  workflow_dispatch:
    inputs:
      artist:
        description: 'Artist Name'
        required: true
        default: 'Taylor Swift'
      album:
        description: 'Album Name'
        required: true
        default: 'Midnights'
      max_tracks_per_run:
        description: 'Max tracks per run (default: 2)'
        required: false
        default: '2'
  # CRON_PLACEHOLDER - This line gets replaced by the workflow

jobs:
  fetch-album:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    permissions:
      contents: write
    outputs:
      album_file: ${{ steps.fetch.outputs.album_file }}
      artist: ${{ steps.fetch.outputs.artist }}
      album: ${{ steps.fetch.outputs.album }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Install dependencies
      run: |
        pip install yt-dlp musicbrainzngs
    
    - name: Fetch album data
      id: fetch
      run: |
        ARTIST="${{ github.event.inputs.artist }}"
        ALBUM="${{ github.event.inputs.album }}"
        
        ARTIST=$(echo "$ARTIST" | xargs)
        ALBUM=$(echo "$ALBUM" | xargs)
        
        python fetch_album.py "$ARTIST" "$ALBUM"
        
        ALBUM_FILE=$(ls -1 *.json | head -1)
        
        if [ -z "$ALBUM_FILE" ]; then
          echo "âŒ No JSON file created"
          exit 1
        fi
        
        ACTUAL_ARTIST=$(echo "$ALBUM_FILE" | sed 's/ - .*//')
        ACTUAL_ALBUM=$(echo "$ALBUM_FILE" | sed 's/.*- //;s/.json$//')
        
        echo "album_file=$ALBUM_FILE" >> $GITHUB_OUTPUT
        echo "artist=$ACTUAL_ARTIST" >> $GITHUB_OUTPUT
        echo "album=$ACTUAL_ALBUM" >> $GITHUB_OUTPUT
        echo "Generated album file: $ALBUM_FILE"
    
    - name: Upload album data
      uses: actions/upload-artifact@v4
      with:
        name: album-data
        path: "*.json"
    
    - name: Enable cron trigger
      if: github.event_name == 'workflow_dispatch'
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # Replace CRON_PLACEHOLDER with actual cron schedule
        sed -i 's/# CRON_PLACEHOLDER - This line gets replaced by the workflow/schedule:\n    - cron: '\''*\/10 * * * *'\''  # Every 10 minutes/' .github/workflows/Album-main.yml
        
        git add .github/workflows/Album-main.yml
        git commit -m "ðŸ¤– Enable cron for album processing"
        git push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  generate-tracks:
    needs: fetch-album
    runs-on: ubuntu-latest
    if: always()
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set workflow variables
      id: vars
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "artist=${{ needs.fetch-album.outputs.artist }}" >> $GITHUB_OUTPUT
          echo "album=${{ needs.fetch-album.outputs.album }}" >> $GITHUB_OUTPUT
          echo "max_tracks=${{ github.event.inputs.max_tracks_per_run }}" >> $GITHUB_OUTPUT
          echo "album_file=${{ needs.fetch-album.outputs.album_file }}" >> $GITHUB_OUTPUT
        elif [ "${{ github.event_name }}" = "schedule" ]; then
          # Load from progress file
          if [ -f album_progress.json ]; then
            ARTIST=$(python3 -c "import json; print(json.load(open('album_progress.json'))['artist'])")
            ALBUM=$(python3 -c "import json; print(json.load(open('album_progress.json'))['album'])")
            ALBUM_FILE="${ARTIST} - ${ALBUM}.json"
            
            echo "artist=$ARTIST" >> $GITHUB_OUTPUT
            echo "album=$ALBUM" >> $GITHUB_OUTPUT
            echo "max_tracks=2" >> $GITHUB_OUTPUT
            echo "album_file=$ALBUM_FILE" >> $GITHUB_OUTPUT
          else
            echo "âŒ No progress file found for scheduled run"
            exit 1
          fi
        fi
    
    - name: Download album data from release
      run: |
        gh release download album-data -p "*.json" || echo "No album data release"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Download progress (if exists)
      continue-on-error: true
      run: |
        gh release download progress-data -p album_progress.json || echo "No previous progress"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Cache GIF dataset
      id: cache-gifs
      uses: actions/cache@v4
      with:
        path: data/giphy.zip
        key: giphy-dataset-v1
    
    - name: Download GIF dataset
      if: steps.cache-gifs.outputs.cache-hit != 'true'
      run: |
        mkdir -p data
        pip install gdown
        gdown --id 1DxON0BqgvY8vX9s4twtmPWmmuVW51pE- -O data/giphy.zip
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg espeak-ng imagemagick
    
    - name: Install Python dependencies
      run: |
        pip install --upgrade pip
        pip install gradio_client groq moviepy soundfile pydub numpy requests
        pip install git+https://github.com/MrViincciLeRoy/LyricFlow.git#egg=LyricFlow[dev]
    
    - name: Run album pipeline
      id: pipeline
      env:
        GROQ_API_KEYS: ${{ secrets.GROQ_API_KEYS }}
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
      run: |
        ALBUM_FILE="${{ steps.vars.outputs.album_file }}"
        MAX_TRACKS="${{ steps.vars.outputs.max_tracks }}"
        
        echo "Looking for album file: $ALBUM_FILE"
        
        if [ ! -f "$ALBUM_FILE" ]; then
          echo "âŒ Album file not found: $ALBUM_FILE"
          echo "Available files:"
          ls -la
          exit 1
        fi
        
        python album_pipeline.py "$ALBUM_FILE" "$MAX_TRACKS"
        echo "status=$?" >> $GITHUB_OUTPUT
    
    - name: Upload album data for next run
      if: always()
      run: |
        ALBUM_FILE="${{ steps.vars.outputs.album_file }}"
        gh release create album-data "$ALBUM_FILE" --title "Album Data" || \
        gh release upload album-data "$ALBUM_FILE" --clobber
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Upload progress tracking
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: album-progress
        path: album_progress.json
    
    - name: Upload completed videos
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: track-videos
        path: outputs/*.mp4
    
    - name: Save progress to release
      if: always()
      run: |
        if [ -f album_progress.json ]; then
          gh release create progress-data album_progress.json --title "Album Progress" || \
          gh release upload progress-data album_progress.json --clobber
        else
          echo "âš ï¸ album_progress.json not found, skipping release upload"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Check if album complete
      id: check_complete
      run: |
        if [ -f album_progress.json ]; then
          STATUS=$(python -c "import json; p=json.load(open('album_progress.json')); print(p['status'])")
          echo "album_status=$STATUS" >> $GITHUB_OUTPUT
          
          if [ "$STATUS" = "completed" ]; then
            echo "âœ… Album complete! Disabling cron..."
          else
            echo "â¸ï¸ More tracks remaining..."
          fi
        else
          echo "album_status=failed" >> $GITHUB_OUTPUT
        fi
    
    - name: Disable cron when complete
      if: steps.check_complete.outputs.album_status == 'completed'
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # Replace cron schedule with placeholder
        sed -i '/schedule:/,/cron:/d' .github/workflows/Album-main.yml
        sed -i 's/on:/on:\n  # CRON_PLACEHOLDER - This line gets replaced by the workflow/' .github/workflows/Album-main.yml
        
        git add .github/workflows/Album-main.yml
        git commit -m "ðŸŽ‰ Disable cron - album processing complete"
        git push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  merge-album:
    needs: generate-tracks
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Download progress
      run: |
        gh release download progress-data -p album_progress.json || echo "No progress"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Check if ready to merge
      id: check_merge
      run: |
        if [ -f album_progress.json ]; then
          STATUS=$(python -c "import json; p=json.load(open('album_progress.json')); print(p['status'])")
          if [ "$STATUS" = "completed" ]; then
            echo "ready=true" >> $GITHUB_OUTPUT
          else
            echo "ready=false" >> $GITHUB_OUTPUT
          fi
        else
          echo "ready=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Download all track artifacts
      if: steps.check_merge.outputs.ready == 'true'
      uses: actions/download-artifact@v4
      with:
        pattern: 'track-videos-*'
        path: outputs
    
    - name: Set up Python
      if: steps.check_merge.outputs.ready == 'true'
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Install dependencies
      if: steps.check_merge.outputs.ready == 'true'
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg
        pip install moviepy
    
    - name: Merge videos
      if: steps.check_merge.outputs.ready == 'true'
      run: |
        python merge_videos.py
    
    - name: Upload full album video
      if: steps.check_merge.outputs.ready == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: full-album-video
        path: outputs/*_full_album.mp4
